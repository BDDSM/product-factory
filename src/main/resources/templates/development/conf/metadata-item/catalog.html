<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head th:include="fragments/header :: common"></head>
    <body>
        <script type="text/javascript" th:src="@{/js/bootstrap-notify.min.js}"></script>

        <!-- highlight -->
        <script type="text/javascript" th:src="@{/webjars/highlightjs/highlight.min.js}"></script>
        <script type="text/javascript" th:src="@{/webjars/highlightjs/languages/1c.min.js}"></script>
        <script>
            hljs.configure({
                languages: ["1C"]
            })
            hljs.initHighlighting();      
        </script>

        <!--todo: исправить навигационную цепочку-->
        <nav th:replace="fragments/navbar :: navbar"></nav>
        <div class="container-fluid pt-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Product Factory</a></li>
                    <li class="breadcrumb-item"><a href="/development/projects">Проекты</a></li>
                    <li class="breadcrumb-item">
                        <a th:href="@{'/development/projects/'+${projectId}}">
                            <span th:text="${projectId}"></span>
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a th:href="@{'/development/conf/item/'+${projectId}}">Конфигурация</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a th:text="${object.listPresentation}" th:href="@{'/development/conf/item/'+${projectId}}"></a>
                    </li>    
                    <li class="breadcrumb-item active" aria-current="page">
                        <span th:text="${object.name}"></span>
                    </li>
                </ol>
            </nav>

            <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="pills-property-tab" data-toggle="pill" href="#pills-property" role="tab" aria-controls="pills-property" aria-selected="true">Основные свойства</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="pills-object-tab" data-toggle="pill" href="#pills-object" role="tab" aria-controls="pills-object" aria-selected="false">Модуль объекта</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="pills-manager-tab" data-toggle="pill" href="#pills-manager" role="tab" aria-controls="pills-manager" aria-selected="false">Модуль менеджера</a>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <!-- Основные свойства -->
                <div class="tab-pane fade show active" id="pills-property" role="tabpanel" aria-labelledby="pills-property-tab">
                    <table id='properties' class="table table-hover">
                        <thead>
                            <tr>
                                <th class="w-25" scope="col">Метаданные</th>
                                <th class="w-75" scope="col">
                                    <span th:text="${object.listPresentation}"></span>
                                </th>
                            </tr>
                        </thead>                
                        <tbody>
                            <tr>
                                <td>UUID</td>
                                <td><span th:text="${object.uuid}"></span></td>
                            </tr>
                            <tr>
                                <td>Имя</td>
                                <td><span th:text="${object.name}"></span></td>
                            </tr>
                            <tr>
                                <td>Синоним</td>
                                <td><span th:text="${object.synonym}"></span></td>
                            </tr>
                            <tr>
                                <td>Комментарий</td>
                                <td><span th:text="${object.comment}"></span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Модуль объекта -->
                <div class="tab-pane fade" id="pills-object" role="tabpanel" aria-labelledby="pills-object-tab">
                    <table id='objectModule_methods' class="table table-hover">
                        <thead>
                            <tr>
                                <th class="w-75" scope="col">Имя</th>  
                                <th class="text-center" scope="col">Функция</th>                              
                                <th class="text-center" scope="col">Пустой</th>
                                <th class="text-center" scope="col">Экспортный</th>
                                <th class="text-center" scope="col">Текст</th>                                
                            </tr>
                        </thead>                
                        <tbody></tbody>
                    </table>        
                </div>

                <!-- Модуль менеджера -->
                <div class="tab-pane fade" id="pills-manager" role="tabpanel" aria-labelledby="pills-manager-tab">
                    <table id='managerModule_methods' class="table table-hover">
                        <thead>
                            <tr>
                                <th class="w-75" scope="col">Имя</th>  
                                <th class="text-center" scope="col">Функция</th>                              
                                <th class="text-center" scope="col">Пустой</th>
                                <th class="text-center" scope="col">Экспортный</th>
                                <th class="text-center" scope="col">Текст</th>                                
                            </tr>
                        </thead>                
                        <tbody></tbody>
                    </table>        
                </div>
            </div>
        </div>

        <!--Modal-->
        <div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="label-detail" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="label-detail">Label</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="body_detail">
                        <pre>
                            <code id="body_code" class="1c"></code>
                        </pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            let object = [[${object}]];

            function addProperties_CommonModule (object) {
                // Иерархия
                addProperty('Иерархический', object.hierarchical);
                if (object.hierarchical) {
                    let hierarchyType = null;
                    if (object.hierarchyType == 'HIERARCHY_OF_ITEMS') {
                        hierarchyType = 'Иерархия элементов';
                    } else if (object.hierarchyType == 'HIERARCHY_FOLDERS_AND_ITEMS') {
                        hierarchyType = 'Иерархия групп и элементов';
                    }
                    addProperty('Вид иерархии', hierarchyType);
                    addProperty('Размещать группы сверху', object.foldersOnTop);

                    addProperty('Ограничение количества уровней иерархии', object.limitLevelCount);
                    if (object.limitLevelCount) {
                        addProperty('Количество уровней иерархии', object.levelCount)
                    }
                }

                addProperty('Использовать стандартные команды', object.useStandardCommands);
            }

            function addProperty(name, value) {
                $('#properties > tbody:last-child')
                    .append($('<tr>')
                        .append($('<td>').text(name))
                        .append($('<td>').text(value))
                    );
            }

            addProperties_CommonModule(object);

            function addMethod(nameModule, name, isFunction, isEmpty, isExport) {
                $('#' + nameModule + '_methods > tbody:last-child')
                    .append($('<tr>')
                        .append($('<td>')
                            .append($('<a>').attr("href", "").text(name)))

                        .append($('<td>').addClass("text-center").text(isFunction))
                        .append($('<td>').addClass("text-center").text(isEmpty))
                        .append($('<td>').addClass("text-center").text(isExport))
                        .append($('<td>').addClass("text-center")
                            .append($('<button>').addClass("btn btn-link")
                                .attr("module", nameModule)
                                .attr("method", name)
                                .attr('data-toggle', 'modal')
                                .attr('data-target', '#detailModal')                                
                                .on('click', function () { btnServiceOnClick(event); })
                                .text("...")))
                    );
            }

            let modules = ['managerModule', 'objectModule'];
            for (let m = 0; m < modules.length; m++) {
                if (object[modules[m]]) {
                    for (let i = 0; i < object[modules[m]].methods.length; i++) {
                        let method = object[modules[m]].methods[i];
                        addMethod(modules[m], method.name, method.function, method.empty, method.export)
                    }
                }
            }

            function btnServiceOnClick(event) {
                let attrMethod = event.target.attributes.getNamedItem('method').value;
                let attrModule = event.target.attributes.getNamedItem('module').value;

                $('#label-detail').html(attrMethod);

                let textMethod = "";
                for (let i = 0; i < object[attrModule].methods.length; i++) {
                    let method = object[attrModule].methods[i];
                    if (method.name === attrMethod) {
                        textMethod = method.text;
                        break;
                    }
                }
                $('#body_code').text(textMethod);

                // todo
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
            }
        </script>
        <footer th:replace="fragments/footer :: bootstrap"></footer>
    </body>
</html>
