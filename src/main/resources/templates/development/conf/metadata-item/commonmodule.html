<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head th:include="fragments/header :: common"></head>
    <body>
        <script type="text/javascript" th:src="@{/js/bootstrap-notify.min.js}"></script>

        <!-- highlight -->
        <script type="text/javascript" th:src="@{/webjars/highlightjs/highlight.min.js}"></script>
        <script type="text/javascript" th:src="@{/webjars/highlightjs/languages/1c.min.js}"></script>
        <script>
            hljs.configure({
                languages: ["1C"]
            })
            hljs.initHighlighting();      
        </script>

        <!--todo: исправить навигационную цепочку-->
        <nav th:replace="fragments/navbar :: navbar"></nav>
        <div class="container-fluid pt-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Product Factory</a></li>
                    <li class="breadcrumb-item"><a href="/development/projects">Проекты</a></li>
                    <li class="breadcrumb-item">
                        <a th:href="@{'/development/projects/'+${projectId}}">
                            <span th:text="${projectId}"></span>
                        </a>
                    </li>
                    <li class="breadcrumb-item">
                        <a th:href="@{'/development/conf/item/'+${projectId}}">Конфигурация</a>
                    </li>
                    <li class="breadcrumb-item">
                        <a th:text="${object.listPresentation}" th:href="@{'/development/conf/item/'+${projectId}}"></a>
                    </li>    
                    <li class="breadcrumb-item active" aria-current="page">
                        <span th:text="${object.name}"></span>
                    </li>
                </ol>
            </nav>

            <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="pills-property-tab" data-toggle="pill" href="#pills-property" role="tab" aria-controls="pills-property" aria-selected="true">Основные свойства</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="pills-profile-tab" data-toggle="pill" href="#pills-profile" role="tab" aria-controls="pills-profile" aria-selected="false">Методы</a>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <!-- Основные свойства -->
                <div class="tab-pane fade show active" id="pills-property" role="tabpanel" aria-labelledby="pills-property-tab">
                    <table id='properties' class="table table-hover">
                        <thead>
                            <tr>
                                <th class="w-25" scope="col">Метаданные</th>
                                <th class="w-75" scope="col">
                                    <span th:text="${object.listPresentation}"></span>
                                </th>
                            </tr>
                        </thead>                
                        <tbody>
                            <tr>
                                <td>UUID</td>
                                <td><span th:text="${object.uuid}"></span></td>
                            </tr>
                            <tr>
                                <td>Имя</td>
                                <td><span th:text="${object.name}"></span></td>
                            </tr>
                            <tr>
                                <td>Синоним</td>
                                <td><span th:text="${object.synonym}"></span></td>
                            </tr>
                            <tr>
                                <td>Комментарий</td>
                                <td><span th:text="${object.comment}"></span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Методы -->
                <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
                    <table id='methods' class="table table-hover">
                        <thead>
                            <tr>
                                <th class="w-75" scope="col">Имя</th>  
                                <th class="text-center" scope="col">Функция</th>                              
                                <th class="text-center" scope="col">Пустой</th>
                                <th class="text-center" scope="col">Экспортный</th>
                                <th class="text-center" scope="col">Текст</th>                                
                            </tr>
                        </thead>                
                        <tbody>

                        </tbody>
                    </table>        
                </div>
            </div>
        </div>

        <!--Modal-->
        <div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="label-detail" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="label-detail">Label</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="body_detail">
                        <pre>
                            <code id="body_code" class="1c"></code>
                        </pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    </div>
                </div>
            </div>
        </div>

        <script th:inline="javascript">
            let object = [[${object}]];

            function addProperties_CommonModule (object) {
                addProperty('Глобальный', object.global);
                addProperty('Клиент (управляемое приложение)', object.clientManagedApplication);
                addProperty('Клиент (обычное приложение)', object.clientOrdinaryApplication);
                addProperty('Сервер', object.server);
                addProperty('Внешнее соединение', object.externalConnection);
                addProperty('Вызов сервера', object.serverCall);
                addProperty('Привелегированный', object.privileged);

                let returnValuesReuse = null;
                if (object.returnValuesReuse === 'DONT_USE') {
                    returnValuesReuse = 'Не использовать';

                } else if (object.returnValuesReuse === 'DURING_REQUEST') {
                    returnValuesReuse = 'На время вызова';

                } else if (object.returnValuesReuse === 'DURING_SESSION') {
                    returnValuesReuse = 'На время сеанса';
                }

                addProperty('Повторное использование', returnValuesReuse);
            }

            function addProperty(name, value) {
                $('#properties > tbody:last-child')
                    .append($('<tr>')
                        .append($('<td>').text(name))
                        .append($('<td>').text(value))
                    );
            }

            addProperties_CommonModule(object);

            function addMethod(name, isFunction, isEmpty, isExport) {
                $('#methods > tbody:last-child')
                    .append($('<tr>')
                        .append($('<td>')
                            .append($('<a>').attr("href", "").text(name)))

                        .append($('<td>').addClass("text-center").text(isFunction))
                        .append($('<td>').addClass("text-center").text(isEmpty))
                        .append($('<td>').addClass("text-center").text(isExport))
                        .append($('<td>').addClass("text-center")
                            .append($('<button>').addClass("btn btn-link")
                                .attr("method", name)
                                .attr('data-toggle', 'modal')
                                .attr('data-target', '#detailModal')                                
                                .on('click', function () { btnServiceOnClick(event); })
                                .text("...")))
                    );
            }

            for (let i = 0; i < object.module.methods.length; i++) {
                let method = object.module.methods[i];
                addMethod(method.name, method.function, method.empty, method.export)
            }

            function btnServiceOnClick(event) {
                let attrMethod = event.target.attributes.getNamedItem('method').value;
                $('#label-detail').html(attrMethod);

                let textMethod = "";
                for (let i = 0; i < object.module.methods.length; i++) {
                    let method = object.module.methods[i];
                    if (method.name === attrMethod) {
                        textMethod = method.text;
                        break;
                    }
                }
                $('#body_code').text(textMethod);

                // todo
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
            }
        </script>
        <footer th:replace="fragments/footer :: bootstrap"></footer>
    </body>
</html>