<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">
    <head th:include="fragments/header :: common"></head>
    <body>
        <script type="text/javascript" th:src="@{/js/bootstrap-notify.min.js}"></script>

        <!-- highlight -->
        <script type="text/javascript" th:src="@{/webjars/highlightjs/highlight.min.js}"></script>
        <script type="text/javascript" th:src="@{/webjars/highlightjs/languages/1c.min.js}"></script>
        <script>
            hljs.configure({
                languages: ["1C"]
            })
            hljs.initHighlighting();      
        </script>

        <nav th:replace="fragments/navbar :: navbar"></nav>
        
        <div class="container-fluid pt-2">
            <nav th:replace="fragments/navbar :: breadcrumb-object"></nav>

            <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" id="pills-property-tab" data-toggle="pill" href="#pills-property" role="tab" aria-controls="pills-property" aria-selected="true">Основные свойства</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="pills-manager-tab" data-toggle="pill" href="#pills-manager" role="tab" aria-controls="pills-manager" aria-selected="false">Модуль менеджера</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="pills-values-tab" data-toggle="pill" href="#pills-values" role="tab" aria-controls="pills-values" aria-selected="false">Значения</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="pills-forms-tab" data-toggle="pill" href="#pills-forms" role="tab" aria-controls="pills-forms" aria-selected="false">Формы</a>
                </li>
            </ul>

            <div class="tab-content" id="pills-tabContent">
                <!-- Основные свойства -->
                <div class="tab-pane fade show active" id="pills-property" role="tabpanel" aria-labelledby="pills-property-tab">
                    <table id='properties' class="table table-hover">
                        <thead>
                            <tr>
                                <th class="w-25" scope="col">Метаданные</th>
                                <th class="w-75" scope="col">
                                    <span th:text="${object.listPresentation}"></span>
                                </th>
                            </tr>
                        </thead>                
                        <tbody>
                            <tr>
                                <td>UUID</td>
                                <td><span th:text="${object.uuid}"></span></td>
                            </tr>
                            <tr>
                                <td>Имя</td>
                                <td><span th:text="${object.name}"></span></td>
                            </tr>
                            <tr>
                                <td>Синоним</td>
                                <td><span th:text="${object.synonym}"></span></td>
                            </tr>
                            <tr>
                                <td>Комментарий</td>
                                <td><span th:text="${object.comment}"></span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Модуль менеджера -->
                <div class="tab-pane fade" id="pills-manager" role="tabpanel" aria-labelledby="pills-manager-tab">
                    <table id='managerModule_methods' class="table table-hover">
                        <thead>
                            <tr>
                                <th class="w-75" scope="col">Имя</th>  
                                <th class="text-center" scope="col">Функция</th>                              
                                <th class="text-center" scope="col">Пустой</th>
                                <th class="text-center" scope="col">Экспортный</th>
                                <th class="text-center" scope="col">Текст</th>                                
                            </tr>
                        </thead>                
                        <tbody></tbody>
                    </table>        
                </div>

                <!-- Значения перечисления -->
                <div class="tab-pane fade" id="pills-values" role="tabpanel" aria-labelledby="pills-values-tab">
                    <table id='enumValues' class="table table-hover">
                        <thead>
                            <tr>
                                <th class="w-75" scope="col">Имя</th>  
                                <th class="text-center" scope="col">Синоним</th>                              
                                <th class="text-center" scope="col">Комментарий</th>
                            </tr>
                        </thead>                
                        <tbody>
                            <tr th:if="${object.values.empty}">
                                <td colspan="3"> Значения отсутствуют </td>
                            </tr>
                            <tr th:each="item : ${object.values}">
                                <td><span th:text="${item.name}"> Имя </span></td>
                                <td class="text-center"><span th:text="${item.synonym}"> Синоним </span></td>
                                <td class="text-center"><span th:text="${item.comment}"> Комментарий </span></td>
                            </tr>        
                        </tbody>
                    </table>        
                </div>

                <!-- Формы -->
                <div class="tab-pane fade" id="pills-forms" role="tabpanel" aria-labelledby="pills-forms-tab">
                    <table id='forms' class="table table-hover">
                        <thead>
                            <tr>
                                <th class="" scope="col">Имя</th>  
                                <th class="" scope="col">UUID</th>                                
                                <th class="" scope="col">Синоним</th>                              
                                <th class="" scope="col">Комментарий</th>                                
                            </tr>
                        </thead>                
                        <tbody></tbody>
                    </table>        
                </div>
                
            </div>
        </div>

        <!--Modal-->
        <div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="label-detail" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="label-detail">Label</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="body_detail">
                        <pre>
                            <code id="body_code" class="1c"></code>
                        </pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Forms -->
        <script th:inline="javascript">
            let hasForms = [[${hasForms}]];
            let fieldForms = [[${fieldForms}]];

            function addForm(form) {
                $('#forms > tbody:last-child')
                    .append($('<tr>')
                        .append($('<td>').text(form.name))
                        .append($('<td>').text(form.uuid))                        
                        .append($('<td>').text(form.synonym))
                        .append($('<td>').text(form.comment))
                    );                
            }

            function addForms() {
                if (hasForms == true) {
                    for (let f = 0; f < object[fieldForms].length; f++) {
                        addForm(object.forms[f]);    
                    }            
                }
            }
        </script>

        <script th:inline="javascript">
            let object = [[${object}]];

            function addProperties (object) {
                addProperty('Использовать стандартные команды', object.useStandardCommands);
            }

            function addProperty(name, value) {
                $('#properties > tbody:last-child')
                    .append($('<tr>')
                        .append($('<td>').text(name))
                        .append($('<td>').text(value))
                    );
            }

            addProperties(object);

            function addMethod(nameModule, name, isFunction, isEmpty, isExport) {
                $('#' + nameModule + '_methods > tbody:last-child')
                    .append($('<tr>')
                        .append($('<td>')
                            .append($('<a>').attr("href", "").text(name)))

                        .append($('<td>').addClass("text-center").text(isFunction))
                        .append($('<td>').addClass("text-center").text(isEmpty))
                        .append($('<td>').addClass("text-center").text(isExport))
                        .append($('<td>').addClass("text-center")
                            .append($('<button>').addClass("btn btn-link")
                                .attr("module", nameModule)
                                .attr("method", name)
                                .attr('data-toggle', 'modal')
                                .attr('data-target', '#detailModal')                                
                                .on('click', function () { btnServiceOnClick(event); })
                                .text("...")))
                    );
            }

            let modules = ['managerModule'];
            for (let m = 0; m < modules.length; m++) {
                if (object[modules[m]]) {
                    for (let i = 0; i < object[modules[m]].methods.length; i++) {
                        let method = object[modules[m]].methods[i];
                        addMethod(modules[m], method.name, method.function, method.empty, method.export)
                    }
                }
            }

            addForms();

            function btnServiceOnClick(event) {
                let attrMethod = event.target.attributes.getNamedItem('method').value;
                let attrModule = event.target.attributes.getNamedItem('module').value;

                $('#label-detail').html(attrMethod);

                let textMethod = "";
                for (let i = 0; i < object[attrModule].methods.length; i++) {
                    let method = object[attrModule].methods[i];
                    if (method.name === attrMethod) {
                        textMethod = method.text;
                        break;
                    }
                }
                $('#body_code').text(textMethod);

                // todo
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightBlock(block);
                });
            }
        </script>
        <footer th:replace="fragments/footer :: bootstrap"></footer>
    </body>
</html>
