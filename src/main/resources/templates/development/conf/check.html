<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity3">
    <head>
        <headCommon th:replace="fragments/header :: common"/>
    </head>
    <body>
        <script type="text/javascript" th:src="@{/js/bootstrap-notify.min.js}"></script>

        <!--todo: исправить навигационную цепочку-->
        <nav th:replace="fragments/navbar :: navbar"/>
        <div class="container-fluid pt-2">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/">Product Factory</a></li>
                    <li class="breadcrumb-item "><a href="/development/projects">Проекты</a></li>
                    <li class="breadcrumb-item ">
                        <a th:href="@{'/development/projects/'+${projectId}}">
                            <span th:text="${projectId}"></span>
                        </a>
                    </li>
                    <li class="breadcrumb-item ">
                        <a th:href="@{'/development/conf/item/'+${projectId}}">Конфигурация</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Проверка</li>
                </ol>
            </nav>

            <table class="table table-hover">
                <thead>
                <tr>
                    <th scope="col" width="70%">Правило</th>
                    <th scope="col" width="30%">Результат</th>
                </tr>
                </thead>
                <tbody>
                <tr th:id="'row_'+${instance.key}" th:each="instance : ${services}">
                    <td th:text="${instance.value.getAlias()}">num</td>
                    <td th:id="'result_'+${instance.key}"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <!--Modal-->
        <div class="modal fade" id="detailModal" tabindex="-1" role="dialog" aria-labelledby="label-detail" aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="label-detail">Label</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body" id="body_detail"></div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            var errors = [];

            function fill_good() {
                $('#label-detail').html('Пройден');
                $('#body_detail').html('По выбранному правилу ошибок не найдено');
            }

            function fill_noReturn(response) {
                $('#label-detail').html('Функции без возврата результата');
                $('#body_detail').html('');

                var $table = $('<table class="table table-hover"/>');
                $table.append($('<thead>')
                    .append($('<tr>')
                        .append($('<th>').text('Модуль'))
                        .append($('<th>').text('Методы'))
                        )
                    );

                var $body = $('<tbody>');
                for (var iModule = 0; iModule < response.objects.length; iModule++) {
                    var module = response.objects[iModule];

                    var $tr = $('<tr>');
                    $tr.append($('<td>').text(module.object.name));

                    var $tdMethods = $('<td>');
                    for (var iMethod = 0; iMethod < module.found.length; iMethod++) {
                        var method = module.found[iMethod];
                        $tdMethods.append($('<p>').text(method.name));
                    }
                    $tr.append($tdMethods);
                    $body.append($tr);
                }
                $table.append($body);

                $('#body_detail').append($table);
            }

            function fill_refRef(response) {
                $('#label-detail').html('Ссылка.Ссылка');

                var $table = $('<table class="table table-hover"/>');
                $table.append($('<thead>')
                    .append($('<tr>')
                        .append($('<th>').text('Модуль'))
                        .append($('<th>').text('Позиции в тексте'))
                    )
                );

                var $body = $('<tbody>');
                for (var iModule = 0; iModule < response.objects.length; iModule++) {
                    var module = response.objects[iModule];

                    var $tr = $('<tr>');
                    $tr.append($('<td>').text(module.object.name));

                    var $tdText = $('<td>');
                    for (var iText = 0; iText < module.found.length; iText++) {
                        var text = module.found[iText];
                        $tdText.append($('<p>').text(text));
                    }
                    $tr.append($tdText);
                    $body.append($tr);
                }
                $table.append($body);

                // todo: исправить
                $('#body_detail').html('');
                $('#body_detail').append($table);
            }

            function fill_subsystem(response) {
                $('#label-detail').html('Не включенные в подсистемы');

                var $table = $('<table class="table table-hover"/>');
                $table.append($('<thead>')
                    .append($('<tr>')
                        .append($('<th>').text('Тип'))
                        .append($('<th>').text('Имя'))
                        .append($('<th>').text('Синоним'))
                    )
                );

                var $body = $('<tbody>');
                for (var iObject = 0; iObject < response.objects.length; iObject++) {
                    var object = response.objects[iObject];
                    $body.append($('<tr>')
                        .append($('<td>').text(object.metadataName))
                        .append($('<td>').text(object.name))
                        .append($('<td>').text(object.synonym))
                    );
                }
                $table.append($body);

                // todo: исправить
                $('#body_detail').html('');
                $('#body_detail').append($table);
            }

            function btnServiceOnClick(event) {
                var attrResult = event.target.attributes.getNamedItem('pf-result');

                if (attrResult && attrResult.value === "false") {
                    var attrService = event.target.attributes.getNamedItem('service').value;

                    var result = null;
                    for (var i = 0; i < errors.length; i++) {
                        if (errors[i].rule === attrService) {
                            result = errors[i].result;
                            break;
                        }
                    }

                    if (result !== null) {
                        if (attrService === 'noreturn') {
                            fill_noReturn(result);

                        } else if (attrService === 'refref') {
                            fill_refRef(result);

                        } else if (attrService === 'subsystem') {
                            fill_subsystem(result);

                        }
                    } else {
                        console.error('Отсутствует результаты правила');
                    }

                } else {
                    fill_good();
                }
            }

            function check(service, projectId) {
                var $button = $('<button>').addClass('btn btn-link')
                    .attr('data-toggle', 'modal')
                    .attr('data-target', '#detailModal')
                    .attr('type', 'button')
                    .attr('id', 'btn_' + service)
                    .attr('service', service)
                    .text('Обработка')
                    .on('click', function () {
                        btnServiceOnClick(event);
                    })
                ;

                $('#result_' + service).append($button);

                $.ajax({
                    type : "GET",
                    contentType : "application/json",
                    url : "/api/conf/check/" + service + "?project=" + projectId,
                    dataType : 'json',
                    timeout : 100000,
                    success : function(data) {
                        $button.text(data.result ? 'Пройден' : 'Не пройден');
                        $button.attr('pf-result', data.result);

                        $('#row_' + service).addClass(data.result ? 'table-success' : 'table-warning');

                        if (!data.result) {
                            errors.push(
                                {
                                    'rule': service,
                                    'result': data
                                }
                            );
                        }
                    },
                    error : function(e) {
                        $('#row_' + service).addClass('table-danger');
                        $('#result_' + service).html("Внутренняя ошибка");
                    },
                });
            }
        </script>

        <script th:inline="javascript">
            for (var service in [[${services}]]) {
                check(service, [[${projectId}]]);
            }
        </script>

        <footer th:replace="fragments/footer :: bootstrap"/>
    </body>
</html>